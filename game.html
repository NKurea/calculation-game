%%html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四則演算ゲーム</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f8ff;
            flex-direction: column;
        }
        #game-container {
            background-color: white;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 550px;
        }
        h1 {
            color: #333;
        }
        .quiz-container {
            font-size: 2.8rem;
            font-weight: bold;
            margin: 20px 0;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quiz-container select {
            font-size: 2.2rem;
            margin: 0 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 5px;
            cursor: pointer;
        }
        .parentheses-container {
            margin-top: 15px;
            font-size: 1.5rem;
        }
        .parentheses-container select {
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .buttons { margin-top: 20px; }
        button {
            font-size: 1.2rem;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        #check-btn { background-color: #4caf50; color: white; }
        #check-btn:hover { background-color: #45a049; }
        #next-btn { background-color: #2196f3; color: white; }
        #next-btn:hover { background-color: #1e87db; }
        #feedback {
            margin-top: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            height: 30px;
        }
        .correct { color: #4caf50; }
        .incorrect { color: #f44336; }
    </style>
</head>
<body>

    <div id="game-container">
        <h1>四則演算ゲーム</h1>
        <div class="quiz-container">
            <span id="num1"></span>
            <select id="operator-select-1">
                <option value="">?</option><option value="+">＋</option><option value="-">－</option><option value="*">×</option><option value="/">÷</option>
            </select>
            <span id="num2"></span>
            <select id="operator-select-2">
                <option value="">?</option><option value="+">＋</option><option value="-">－</option><option value="*">×</option><option value="/">÷</option>
            </select>
            <span id="num3"></span>
            <span> = </span>
            <span id="result"></span>
        </div>
        <div class="parentheses-container">
            <label for="parentheses-select"><b>括弧の位置:</b></label>
            <select id="parentheses-select">
                <option value="">?</option>
                <option value="none">括弧なし</option>
                <option value="paren12">(□ ？ □) ？ □</option>
                <option value="paren23">□ ？ (□ ？ □)</option>
            </select>
        </div>
        <div class="buttons">
            <button id="check-btn">答え合わせ</button>
            <button id="next-btn">次の問題</button>
        </div>
        <p id="feedback"></p>
    </div>

    <script>
        const num1Elem = document.getElementById('num1');
        const num2Elem = document.getElementById('num2');
        const num3Elem = document.getElementById('num3');
        const resultElem = document.getElementById('result');
        const operatorSelect1 = document.getElementById('operator-select-1');
        const operatorSelect2 = document.getElementById('operator-select-2');
        const parenthesesSelect = document.getElementById('parentheses-select');
        const checkBtn = document.getElementById('check-btn');
        const nextBtn = document.getElementById('next-btn');
        const feedbackElem = document.getElementById('feedback');

        let correctOperator1, correctOperator2, correctParentheses;
        const ALL_OPERATORS = ['+', '-', '*', '/'];

        // MARK: 式を評価するコア関数
        // (n1, op1, n2, op2, n3) と括弧の有無から答えを計算する
        // 計算不能な場合はnullを返す
        function evaluateExpression(n1, n2, n3, op1, op2, parenthesesMode) {
            const highPriority = op => op === '*' || op === '/';

            // Helper for calculation and integer check
            const safeCalculate = (a, op, b) => {
                if (op === '/' && b === 0) return null; // Division by zero
                const res = calculate(a, op, b);
                return Number.isInteger(res) ? res : null;
            };

            let result;

            if (parenthesesMode === 'paren12') {
                const intermediate = safeCalculate(n1, op1, n2);
                if (intermediate === null) return null;
                result = safeCalculate(intermediate, op2, n3);
            } else if (parenthesesMode === 'paren23') {
                const intermediate = safeCalculate(n2, op2, n3);
                if (intermediate === null) return null;
                result = safeCalculate(n1, op1, intermediate);
            } else { // parenthesesMode === 'none'
                if (highPriority(op1) && !highPriority(op2)) {
                    const intermediate = safeCalculate(n1, op1, n2);
                    if (intermediate === null) return null;
                    result = safeCalculate(intermediate, op2, n3);
                } else if (!highPriority(op1) && highPriority(op2)) {
                    const intermediate = safeCalculate(n2, op2, n3);
                    if (intermediate === null) return null;
                    result = safeCalculate(n1, op1, intermediate);
                }
 else { // Both high or both low priority, or same priority (left-to-right)
                    const intermediate = safeCalculate(n1, op1, n2);
                    if (intermediate === null) return null;
                    result = safeCalculate(intermediate, op2, n3);
                }
            }
            return result;
        }

        const calculate = (a, op, b) => {
            if (op === '+') return a + b;
            if (op === '-') return a - b;
            if (op === '*') return a * b;
            if (op === '/') return a / b;
        };

        const getDivisors = (num) => {
            const divisors = [];
            // Start from 2 to avoid trivial divisions by 1 or the number itself for game context
            // Also, only consider divisors up to sqrt(num) for efficiency and then add pairs.
            // For this game, simpler loop up to num/2 is fine for small numbers.
            for (let i = 2; i <= num / 2; i++) {
                if (num % i === 0) divisors.push(i);
            }
            return divisors;
        };

        function generateQuestion() {
            const MAX_GEN_ATTEMPTS = 10000; // Increased attempts for robustness
            let attempts = 0;

            while (attempts < MAX_GEN_ATTEMPTS) {
                attempts++;

                // 1. Generate random numbers
                let n1 = Math.floor(Math.random() * 20) + 1; // 1-20
                let n2 = Math.floor(Math.random() * 20) + 1; // 1-20
                let n3 = Math.floor(Math.random() * 20) + 1; // 1-20

                // 2. Generate random operators
                const op1 = ALL_OPERATORS[Math.floor(Math.random() * ALL_OPERATORS.length)];
                const op2 = ALL_OPERATORS[Math.floor(Math.random() * ALL_OPERATORS.length)];

                const possibleParenthesesModes = ['none', 'paren12', 'paren23'];
                const candidateSolutions = []; // Stores { result, parenthesesMode } for the chosen op1, op2

                // Evaluate for all possible parentheses modes with the randomly chosen op1, op2
                for (const testParenMode of possibleParenthesesModes) {
                    const res = evaluateExpression(n1, n2, n3, op1, op2, testParenMode);
                    if (res !== null && res >= 0 && res <= 250) { // Check for valid result and range
                        candidateSolutions.push({ result: res, parenthesesMode: testParenMode });
                    }
                }

                if (candidateSolutions.length === 0) { // No valid solutions for these numbers/ops
                    continue;
                }

                // Pick one of the valid solutions randomly as the "correct" one for display/feedback
                const chosenSolution = candidateSolutions[Math.floor(Math.random() * candidateSolutions.length)];

                // All checks passed, we found a good question!
                correctOperator1 = op1;
                correctOperator2 = op2;
                correctParentheses = chosenSolution.parenthesesMode; // Store the mode string directly
                let finalResult = chosenSolution.result;

                num1Elem.textContent = n1;
                num2Elem.textContent = n2;
                num3Elem.textContent = n3;
                resultElem.textContent = finalResult;

                feedbackElem.textContent = '';
                operatorSelect1.value = '';
                operatorSelect2.value = '';
                parenthesesSelect.value = '';
                return; // Exit the function
            }
            console.warn("Failed to generate a valid question after " + MAX_GEN_ATTEMPTS + " attempts.");
        }

        function checkAnswer() {
            const selectedOp1 = operatorSelect1.value;
            const selectedOp2 = operatorSelect2.value;
            const selectedParentheses = parenthesesSelect.value;

            if (selectedOp1 === '' || selectedOp2 === '' || selectedParentheses === '') {
                alert('演算子と括弧の位置をすべて選択してください！');
                return;
            }

            const n1 = parseInt(num1Elem.textContent);
            const n2 = parseInt(num2Elem.textContent);
            const n3 = parseInt(num3Elem.textContent);
            const targetResult = parseInt(resultElem.textContent);

            // Evaluate user's selected expression
            const userResult = evaluateExpression(n1, n2, n3, selectedOp1, selectedOp2, selectedParentheses);

            // Convert internal operator symbols to display symbols
            const getDisplayOperator = (op) => {
                if (op === '+') return '＋';
                if (op === '-') return '－';
                if (op === '*') return '×';
                if (op === '/') return '÷';
                return op; // Should not happen
            };

            if (userResult !== null && userResult === targetResult) { // Check if user's calculation is valid and matches target
                feedbackElem.textContent = '大正解！';
                feedbackElem.className = 'correct';
            } else {
                let parenthesesText;
                if (correctParentheses === 'none') parenthesesText = '括弧なし';
                else if (correctParentheses === 'paren12') parenthesesText = '(□ ？ □) ？ □';
                else parenthesesText = '□ ？ (□ ？ □)';

                const op1Display = getDisplayOperator(correctOperator1);
                const op2Display = getDisplayOperator(correctOperator2);

                feedbackElem.textContent = `残念... 正解は「${op1Display}」「${op2Display}」で括弧は「${parenthesesText}」でした`;
                feedbackElem.className = 'incorrect';
            }
        }

        checkBtn.addEventListener('click', checkAnswer);
        nextBtn.addEventListener('click', generateQuestion);

        generateQuestion();
    </script>

</body>
</html>
